<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>YouTube Search and Player</title>
<style>
    :root{
        --bg:#060712;
        --bar:#ffffff;
        --text-color:#071127;
        --primary-color:#1e40af;
        --primary-hover:#1d4ed8;
        --muted:#94a3b8;
        --shadow:0 12px 40px rgba(2,6,23,0.6);
    }
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,sans-serif;}
    body{
        background:var(--bg);
        color: #fff;
        overflow:hidden;
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
    }

    .has-results { justify-content:flex-start; padding-top: 4vh; }

    #player {
        position:fixed;
        inset:0;
        z-index:0;
        background:#000;
        transition: opacity 500ms ease;
        opacity: 0;
        pointer-events: none;
    }
    #player.active { opacity: 1; pointer-events: auto; }
    #player iframe{ width:100%; height:100%; border:0; }

    .mode-toggle {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 10;
        display: flex;
        gap: 8px;
        background: rgba(255, 255, 255, 0.1);
        padding: 6px;
        border-radius: 8px;
        backdrop-filter: blur(10px);
    }
    .mode-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: #fff;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 200ms ease;
    }
    .mode-btn.active {
        background: var(--primary-color);
        color: #fff;
    }
    .mode-btn:hover:not(.active) {
        background: rgba(255, 255, 255, 0.1);
    }

    .bar-wrap { position:relative; z-index:2; width:min(880px,92%); }
    .bar {
        width:100%; display:flex; align-items:center; gap:12px;
        background:var(--bar); color:var(--text-color); padding:14px 18px;
        border-radius:12px; box-shadow:var(--shadow);
    }
    .bar input{ flex:1; border:0; outline:0; font-size:16px; font-weight:600; background:transparent; }
    .bar button{
        background:var(--primary-color); color:#fff; border:0; padding:10px 14px;
        border-radius:8px; font-weight:700; cursor:pointer;
    }

    .shake { animation:shake 420ms; }
    @keyframes shake {
        0%{ transform:translateX(0) } 20%{ transform:translateX(-8px) }
        40%{ transform:translateX(6px) } 60%{ transform:translateX(-4px) }
        80%{ transform:translateX(2px) } 100%{ transform:translateX(0) }
    }

    .launched .bar { animation: liftAway 820ms forwards; }
    @keyframes liftAway {
        100% { transform: translateY(-140vh); opacity:0; }
    }
    .launched .mode-toggle { 
        animation: fadeOut 820ms forwards; 
        pointer-events: none;
    }
    @keyframes fadeOut {
        100% { opacity: 0; transform: translateY(-50px); }
    }
    .gone { display:none !important; }

    #results {
        max-width:980px; width:92%; margin-top: 30px;
        list-style: none; padding: 0; z-index: 1;
        overflow-y: auto; max-height: 80vh;
        opacity: 0; transition: opacity 300ms ease;
    }
    .has-results #results { opacity: 1; }

    .video-result {
        display: flex; gap: 20px; padding: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer; background: rgba(255, 255, 255, 0.03);
        border-radius: 8px; margin-bottom: 8px;
    }
    .video-result:hover { background: rgba(255, 255, 255, 0.08); }

    .video-thumbnail { width: 240px; height: 135px; border-radius: 6px; overflow: hidden; flex-shrink: 0; }
    .video-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
    .video-title { font-size: 1.1rem; font-weight: 600; margin: 0 0 6px 0; }
    .video-metadata { font-size: 0.9rem; color: var(--muted); }

    #messageBox {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #fef2f2; color: #dc2626; padding: 16px 24px;
        border-radius: 8px; z-index: 100; display: none;
    }
    #messageBox.show { display: block; }

    @media (max-width:640px){
        .video-result { flex-direction: column; }
        .video-thumbnail { width: 100%; height: auto; }
    }
</style>
</head>
<body>
    <div class="mode-toggle">
        <button class="mode-btn active" data-mode="embed">Embed</button>
        <button class="mode-btn" data-mode="scrape">Scrape</button>
    </div>

    <div id="player"><iframe id="ytframe" allow="autoplay; fullscreen"></iframe></div>

    <div class="bar-wrap" id="barWrap">
        <form id="form" class="bar" autocomplete="off">
            <input id="input" type="text" placeholder="Search a keyword or paste a link" />
            <button type="submit">Search / Launch</button>
        </form>
    </div>

    <ul id="results"></ul>
    <div id="messageBox"></div>

<script>
(function(){
    const form = document.getElementById('form'), input = document.getElementById('input');
    const frame = document.getElementById('ytframe'), player = document.getElementById('player');
    const body = document.body, wrap = document.getElementById('barWrap');
    const resultsList = document.getElementById('results'), messageBox = document.getElementById('messageBox');

    // Mode toggle functionality
    let currentMode = 'embed';
    const modeButtons = document.querySelectorAll('.mode-btn');
    
    modeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            modeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.mode;
        });
    });

    // Updated API Base
    const SEARCH_API = 'https://vapor.my/worker/watch/yt/search/';
    const SCRAPE_API = 'https://rvybrtfpovluhazcbnes.supabase.co/functions/v1/youtube-download';
    const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2eWJydGZwb3ZsdWhhemNibmVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMzc1MjYsImV4cCI6MjA4MzkxMzUyNn0.YVPOXU7B2qrI5OgGcbGaQ_DDNYReoFcOESY9hE6fgx4';

    function showMessage(msg) {
        messageBox.textContent = msg;
        messageBox.classList.add('show');
        setTimeout(() => messageBox.classList.remove('show'), 3000);
    }

    function processInput(text){
        if(!text) return null;
        text = text.trim();
        const idRegex = /^[A-Za-z0-9_-]{11}$/;

        if(idRegex.test(text)) return { id: text };
        try {
            const url = new URL(text.includes('://') ? text : 'https://' + text);
            if(url.hostname === 'youtu.be') return { id: url.pathname.slice(1) };
            if(url.hostname.includes('youtube.com')) return { id: url.searchParams.get('v') };
        } catch(e) {}
        return { query: text };
    }

    async function launchPlayer(id){
        if (currentMode === 'embed') {
            // Original embed functionality
            frame.src = `https://www.youtube-nocookie.com/embed/${id}?autoplay=1`;
            body.classList.add('launched');
            player.classList.add('active');
            resultsList.innerHTML = '';
            body.classList.remove('has-results');
        } else {
            // Scrape mode - get direct video URL
            showMessage('Getting video stream...');
            try {
                const response = await fetch(SCRAPE_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({ url: `https://www.youtube.com/watch?v=${id}` })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                let videoUrl = '';
                if (data.videoUrl) {
                    videoUrl = data.videoUrl;
                } else if (data.medias && data.medias.length > 0) {
                    const videoFormats = data.medias.filter(media => media.extension === 'mp4' && !media.is_audio);
                    if (videoFormats.length > 0) {
                        const bestVideo = videoFormats.reduce((best, current) => {
                            return (current.height || 0) > (best.height || 0) ? current : best;
                        });
                        videoUrl = bestVideo.url;
                    }
                }

                if (!videoUrl) {
                    throw new Error('No video URL found');
                }

                // Create video element and play fullscreen
                frame.style.display = 'none';
                player.innerHTML = `<video controls autoplay style="width:100%;height:100%;object-fit:contain;background:#000;">
                    <source src="${videoUrl}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>`;
                
                body.classList.add('launched');
                player.classList.add('active');
                resultsList.innerHTML = '';
                body.classList.remove('has-results');
                
            } catch (error) {
                showMessage(`Error: ${error.message}`);
            }
        }
    }

    async function fetchAndRenderResults(query) {
        resultsList.innerHTML = '<li style="text-align:center; padding: 20px; color:var(--muted);">Searching...</li>';
        body.classList.add('has-results');

        try {
            // New API structure: /search/QUERY?max=20
            const response = await fetch(`${SEARCH_API}${encodeURIComponent(query)}?max=20`);
            const data = await response.json();

            if (data.ok && data.results) {
                renderResults(data.results);
            } else {
                throw new Error("Invalid response");
            }
        } catch (error) {
            resultsList.innerHTML = '<li style="text-align:center; padding: 20px; color:#ef4444;">Search failed.</li>';
        }
    }

    function renderResults(videos) {
        resultsList.innerHTML = '';
        videos.forEach(video => {
            const li = document.createElement('li');
            li.className = 'video-result';
            li.innerHTML = `
                <div class="video-thumbnail"><img src="${video.thumbnail}" alt=""></div>
                <div class="video-info">
                    <p class="video-title">${video.title}</p>
                    <p class="video-metadata">${video.channel}</p>
                </div>`;
            li.onclick = () => launchPlayer(video.id);
            resultsList.appendChild(li);
        });
    }

    form.onsubmit = (e) => {
        e.preventDefault();
        const res = processInput(input.value);
        if(!res) return;
        res.id ? launchPlayer(res.id) : fetchAndRenderResults(res.query);
    };
})();
</script>
</body>
</html>
